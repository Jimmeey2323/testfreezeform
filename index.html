<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Membership Form</title>
<style>
  body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
  .container { width: 80%; margin: auto; padding: 20px; background: #fff; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); border-radius: 8px; }
  input, select, button { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
  button { background-color: #007BFF; color: white; border: none; cursor: pointer; }
  button:hover { background-color: #0056b3; }
  .hidden { display: none; }
  .spinner { display: none; margin: 20px auto; border: 4px solid #f3f3f3; border-top: 4px solid #007BFF; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css">
</head>
<body>
<div class="container">
  <img src="https://i.imgur.com/9mOm7gP.png" alt="Logo" style="width: 100px; display: block; margin: auto;">
  <form id="userForm">
    <input type="text" id="firstName" placeholder="First Name" required>
    <input type="text" id="lastName" placeholder="Last Name" required>
    <select id="phoneCode" required>
      <option value="+1">United States (+1)</option>
      <option value="+91">India (+91)</option>
      <!-- Add other countries as needed -->
    </select>
    <input type="text" id="phoneNumber" placeholder="Phone Number" required>
    <input type="email" id="email" placeholder="Email" required>
    <button type="button" onclick="authenticateAndSearch()">Go</button>
  </form>
  <div id="membershipOptions" class="hidden">
    <form id="membershipForm">
      <!-- Membership options will be populated here -->
      <input type="date" id="startDate" required>
      <input type="date" id="endDate" required>
      <button type="button" onclick="submitMembership()">Submit</button>
    </form>
  </div>
  <div id="spinner" class="spinner"></div>
</div>

<script>
const loginUrl = 'https://api.momence.com/auth/login';
const email = 'jimmeey@physique57india.com';
const password = 'Jimmeey@123';
let sessionCookie = null;

function authenticateAndSearch() {
  showSpinner(true);
  const loginHeaders = {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
  };
  const loginPayload = JSON.stringify({ email, password });

  fetch(loginUrl, {
    method: 'POST',
    headers: loginHeaders,
    body: loginPayload,
    credentials: 'include'  // Ensure credentials are included
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Authentication failed with status: ' + response.status);
    }
    console.log('Response Headers:', response.headers);  // Log response headers
    return response.json();
  })
  .then(data => {
    console.log('Authentication successful, received data:', data);
    const setCookieHeader = response.headers.get('Set-Cookie');
    if (!setCookieHeader) {
      throw new Error('Set-Cookie header is missing in the response');
    }
    sessionCookie = setCookieHeader.split(';')[0];
    searchCustomer();
  })
  .catch(error => {
    console.error('Error during authentication:', error);
    showSpinner(false);
  });
}

function searchCustomer() {
  const phoneNumber = document.getElementById('phoneCode').value + document.getElementById('phoneNumber').value;
  const searchUrl = `https://api.momence.com/host/13752/search?query=${phoneNumber}&summary=true`;

  fetch(searchUrl, {
    method: 'GET',
    headers: { 'Cookie': sessionCookie },
    credentials: 'include'  // Ensure credentials are included
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Failed to fetch customer with status: ' + response.status);
    }
    return response.json();
  })
  .then(data => {
    console.log('Customer search successful, received data:', data);
    fetchMemberships(data.customerId);
  })
  .catch(error => {
    console.error('Error fetching customer:', error);
    showSpinner(false);
  });
}

function fetchMemberships(customerId) {
  const subscriptionsUrl = `https://readonly-api.momence.com/host/13752/customers/${customerId}/subscriptions?type=active`;
  const packsUrl = `https://readonly-api.momence.com/host/13752/customers/${customerId}/packs?type=active`;

  Promise.all([
    fetch(subscriptionsUrl, { headers: { 'Cookie': sessionCookie }, credentials: 'include' }).then(res => {
      if (!res.ok) {
        throw new Error('Failed to fetch subscriptions with status: ' + res.status);
      }
      return res.json();
    }),
    fetch(packsUrl, { headers: { 'Cookie': sessionCookie }, credentials: 'include' }).then(res => {
      if (!res.ok) {
        throw new Error('Failed to fetch packs with status: ' + res.status);
      }
      return res.json();
    })
  ])
  .then(([subscriptions, packs]) => {
    console.log('Fetched memberships:', { subscriptions, packs });
    const memberships = [...subscriptions, ...packs];
    displayMembershipOptions(memberships);
    showSpinner(false);
  })
  .catch(error => {
    console.error('Error fetching memberships:', error);
    showSpinner(false);
  });
}

function displayMembershipOptions(memberships) {
  const container = document.getElementById('membershipOptions');
  container.innerHTML = '';
  memberships.forEach(membership => {
    const option = document.createElement('input');
    option.type = 'checkbox';
    option.value = membership.id;
    option.id = 'membership' + membership.id;
    container.appendChild(option);

    const label = document.createElement('label');
    label.htmlFor = 'membership' + membership.id;
    label.textContent = membership.name;
    container.appendChild(label);
  });
  container.classList.remove('hidden');
}

function submitMembership() {
  const selectedMembershipId = document.querySelector('input[type="checkbox"]:checked').value;
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const freezeUrl = `https://api.momence.com/host/13752/bought-memberships/${selectedMembershipId}/schedule-freeze`;
  const unfreezeUrl = `https://api.momence.com/host/13752/bought-memberships/${selectedMembershipId}/schedule-unfreeze`;

  Promise.all([
    fetch(freezeUrl, {
      method: 'POST',
      headers: { 'Cookie': sessionCookie },
      body: JSON.stringify({ startDate, endDate }),
      credentials: 'include'  // Ensure credentials are included
    }),
    fetch(unfreezeUrl, {
      method: 'POST',
      headers: { 'Cookie': sessionCookie },
      body: JSON.stringify({ startDate, endDate }),
      credentials: 'include'  // Ensure credentials are included
    })
  ])
  .then(() => {
    alert('Membership updated successfully!');
    showSpinner(false);
  })
  .catch(error => {
    console.error('Error updating membership:', error);
    showSpinner(false);
  });
}

function showSpinner(show) {
  const spinner = document.getElementById('spinner');
  spinner.style.display = show ? 'block' : 'none';
}
</script>
</body>
</html>
