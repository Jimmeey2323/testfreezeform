<!DOCTYPE html>
<html>
<head>
  <title>API Form</title>
  <style>
    /* Add your custom styles here */
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      width: 100%;
    }
    .logo {
      display: block;
      margin: 0 auto 20px;
      max-width: 200px;
    }
    .spinner {
      display: none;
      margin: 20px auto;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
    button {
      background-color: #3498db;
      color: #fff;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 16px;
    }
    button:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
  <div class="container">
    <img class="logo" src="https://i.imgur.com/9mOm7gP.png" alt="Logo">

    <form id="apiForm">
      <div class="form-group">
        <label for="firstName">First Name:</label>
        <input type="text" id="firstName" name="firstName" required>
      </div>

      <div class="form-group">
        <label for="lastName">Last Name:</label>
        <input type="text" id="lastName" name="lastName" required>
      </div>

      <div class="form-group">
        <label for="phone">Phone Number:</label>
        <select id="countryCode" name="countryCode">
          <option value="US">United States (+1)</option>
          <option value="IN">India (+91)</option>
          <!-- Add more country options as needed -->
        </select>
        <input type="text" id="phone" name="phone" required>
      </div>

      <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>
      </div>

      <button type="button" onclick="go()">Go</button>
    </form>

    <div id="spinner" class="spinner"></div>
  </div>

  <script>
    const loginUrl = 'https://api.momence.com/auth/login';
    const email = 'jimmeey@physique57india.com';
    const password = 'Jimmeey@123';

    function authenticate() {
      const loginHeaders = {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      };

      const loginPayload = {
        email: email,
        password: password,
      };

      return fetch(loginUrl, {
        method: 'POST',
        headers: loginHeaders,
        body: JSON.stringify(loginPayload),
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Authentication failed: ' + response.statusText);
          }
          const cookie = response.headers.get('Set-Cookie');
          return cookie ? cookie.split(';')[0] : null; // Extract the session cookie
        })
        .catch(error => {
          console.error('Error during authentication:', error);
          return null;
        });
    }

    function go() {
      const form = document.getElementById('apiForm');
      const firstName = form.elements.firstName.value;
      const lastName = form.elements.lastName.value;
      const countryCode = form.elements.countryCode.value;
      const phone = form.elements.phone.value;
      const email = form.elements.email.value;

      // Show spinner
      const spinner = document.getElementById('spinner');
      spinner.style.display = 'block';

      authenticate()
        .then(cookie => {
          if (cookie) {
            const apiUrl = `https://api.momence.com/host/13752/search?query=${phone}&summary=true`;

            // Make the first API call
            return fetch(apiUrl, {
              headers: {
                'Cookie': cookie,
              },
            })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Error during API call: ' + response.statusText);
                }
                return response.json();
              })
              .then(data => {
                const id = data.id;

                // Make the second API calls
                const subscriptionsUrl = `https://readonly-api.momence.com/host/13752/customers/${id}/subscriptions?type=active`;
                const packsUrl = `https://readonly-api.momence.com/host/13752/customers/${id}/packs?type=active`;

                return Promise.all([
                  fetch(subscriptionsUrl, { headers: { 'Cookie': cookie } }),
                  fetch(packsUrl, { headers: { 'Cookie': cookie } })
                ])
                  .then(responses => Promise.all(responses.map(response => {
                    if (!response.ok) {
                      throw new Error('Error during API call: ' + response.statusText);
                    }
                    return response.json();
                  })))
                  .then(results => {
                    const subscriptions = results[0];
                    const packs = results[1];

                    // Hide spinner
                    spinner.style.display = 'none';

                    // Display the memberships/packs as tickbox options
                    const membershipsDiv = document.createElement('div');
                    membershipsDiv.innerHTML = '<h3>Memberships/Packs:</h3>';
                    form.appendChild(membershipsDiv);

                    subscriptions.forEach(subscription => {
                      const checkbox = document.createElement('input');
                      checkbox.type = 'checkbox';
                      checkbox.name = 'membership';
                      checkbox.value = subscription.id;

                      const label = document.createElement('label');
                      label.textContent = subscription.name;

                      membershipsDiv.appendChild(checkbox);
                      membershipsDiv.appendChild(label);
                      membershipsDiv.appendChild(document.createElement('br'));
                    });

                    packs.forEach(pack => {
                      const checkbox = document.createElement('input');
                      checkbox.type = 'checkbox';
                      checkbox.name = 'membership';
                      checkbox.value = pack.id;

                      const label = document.createElement('label');
                      label.textContent = pack.name;

                      membershipsDiv.appendChild(checkbox);
                      membershipsDiv.appendChild(label);
                      membershipsDiv.appendChild(document.createElement('br'));
                    });

                    // Add date picker fields and submit button
                    const startDateLabel = document.createElement('label');
                    startDateLabel.textContent = 'Start Date:';
                    const startDateInput = document.createElement('input');
                    startDateInput.type = 'date';

                    const endDateLabel = document.createElement('label');
                    endDateLabel.textContent = 'End Date:';
                    const endDateInput = document.createElement('input');
                    endDateInput.type = 'date';

                    const submitButton = document.createElement('button');
                    submitButton.type = 'button';
                    submitButton.textContent = 'Submit';
                    submitButton.addEventListener('click', () => {
                      const selectedMemberships = Array.from(form.elements.membership)
                        .filter(checkbox => checkbox.checked)
                        .map(checkbox => checkbox.value);

                      // Make the third and fourth API calls
                      selectedMemberships.forEach(membershipId => {
                        const freezeUrl = `https://api.momence.com/host/13752/bought-memberships/${membershipId}/schedule-freeze`;
                        const unfreezeUrl = `https://api.momence.com/host/13752/bought-memberships/${membershipId}/schedule-unfreeze`;

                        // Make the third API call
                        fetch(freezeUrl, {
                          method: 'POST',
                          headers: {
                            'Cookie': cookie,
                            'Content-Type': 'application/json'
                          },
                          body: JSON.stringify({
                            start_date: startDateInput.value,
                            end_date: endDateInput.value
                          })
                        })
                          .then(response => {
                            if (!response.ok) {
                              throw new Error('Error during freeze API call: ' + response.statusText);
                            }
                            return response.json();
                          })
                          .then(data => {
                            console.log('Freeze response:', data);
                          })
                          .catch(error => {
                            console.error('Error during freeze API call:', error);
                          });

                        // Make the fourth API call
                        fetch(unfreezeUrl, {
                          method: 'POST',
                          headers: {
                            'Cookie': cookie,
                            'Content-Type': 'application/json'
                          },
                          body: JSON.stringify({
                            start_date: startDateInput.value,
                            end_date: endDateInput.value
                          })
                        })
                          .then(response => {
                            if (!response.ok) {
                              throw new Error('Error during unfreeze API call: ' + response.statusText);
                            }
                            return response.json();
                          })
                          .then(data => {
                            console.log('Unfreeze response:', data);
                          })
                          .catch(error => {
                            console.error('Error during unfreeze API call:', error);
                          });
                      });
                    });

                    form.appendChild(startDateLabel);
                    form.appendChild(startDateInput);
                    form.appendChild(document.createElement('br'));
                    form.appendChild(endDateLabel);
                    form.appendChild(endDateInput);
                    form.appendChild(document.createElement('br'));
                    form.appendChild(submitButton);
                  });
              });
          } else {
            throw new Error('Authentication failed. Unable to retrieve session cookie.');
          }
        })
        .catch(error => {
          // Hide spinner
          spinner.style.display = 'none';

          // Handle errors
          console.error('Error:', error);
        });
    }
  </script>
</body>
</html>
