<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Membership Form</title>
<style>
  body { font-family: Arial, sans-serif; }
  .container { width: 80%; margin: auto; padding: 20px; }
  input, select, button { width: 100%; padding: 10px; margin: 10px 0; }
  .hidden { display: none; }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css">
</head>
<body>
<div class="container">
  <img src="https://i.imgur.com/9mOm7gP.png" alt="Logo" style="width: 100px; display: block; margin: auto;">
  <form id="userForm">
    <input type="text" id="firstName" placeholder="First Name" required>
    <input type="text" id="lastName" placeholder="Last Name" required>
    <select id="phoneCode" required>
      <option value="+1">United States (+1)</option>
      <option value="+91">India (+91)</option>
      <!-- Add other countries as needed -->
    </select>
    <input type="text" id="phoneNumber" placeholder="Phone Number" required>
    <input type="email" id="email" placeholder="Email" required>
    <button type="button" onclick="authenticateAndSearch()">Go</button>
  </form>
  <div id="membershipOptions" class="hidden">
    <form id="membershipForm">
      <!-- Membership options will be populated here -->
      <input type="date" id="startDate" required>
      <input type="date" id="endDate" required>
      <button type="button" onclick="submitMembership()">Submit</button>
    </form>
  </div>
  <div id="spinner" class="hidden">Loading...</div>
</div>

<script>
const loginUrl = 'https://api.momence.com/auth/login';
const email = 'jimmeey@physique57india.com';
const password = 'Jimmeey@123';
let sessionCookie = null;

function authenticateAndSearch() {
  showSpinner(true);
  const loginHeaders = {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
  };
  const loginPayload = JSON.stringify({ email, password });

  fetch(loginUrl, {
    method: 'POST',
    headers: loginHeaders,
    body: loginPayload
  })
  .then(response => response.json())
  .then(data => {
    sessionCookie = data.headers['Set-Cookie'].split(';')[0];
    searchCustomer();
  })
  .catch(error => {
    console.error('Error during authentication:', error);
    showSpinner(false);
  });
}

function searchCustomer() {
  const phoneNumber = document.getElementById('phoneCode').value + document.getElementById('phoneNumber').value;
  const searchUrl = `https://api.momence.com/host/13752/search?query=${phoneNumber}&summary=true`;

  fetch(searchUrl, {
    method: 'GET',
    headers: { 'Cookie': sessionCookie }
  })
  .then(response => response.json())
  .then(data => {
    // Assuming data contains customer ID
    fetchMemberships(data.customerId);
  })
  .catch(error => {
    console.error('Error fetching customer:', error);
    showSpinner(false);
  });
}

function fetchMemberships(customerId) {
  const subscriptionsUrl = `https://readonly-api.momence.com/host/13752/customers/${customerId}/subscriptions?type=active`;
  const packsUrl = `https://readonly-api.momence.com/host/13752/customers/${customerId}/packs?type=active`;

  Promise.all([
    fetch(subscriptionsUrl, { headers: { 'Cookie': sessionCookie } }).then(res => res.json()),
    fetch(packsUrl, { headers: { 'Cookie': sessionCookie } }).then(res => res.json())
  ])
  .then(([subscriptions, packs]) => {
    const memberships = [...subscriptions, ...packs];
    displayMembershipOptions(memberships);
    showSpinner(false);
  })
  .catch(error => {
    console.error('Error fetching memberships:', error);
    showSpinner(false);
  });
}

function displayMembershipOptions(memberships) {
  const container = document.getElementById('membershipOptions');
  container.innerHTML = '';
  memberships.forEach(membership => {
    const option = document.createElement('input');
    option.type = 'checkbox';
    option.value = membership.id;
    option.id = 'membership' + membership.id;
    container.appendChild(option);

    const label = document.createElement('label');
    label.htmlFor = 'membership' + membership.id;
    label.textContent = membership.name;
    container.appendChild(label);
  });
  container.classList.remove('hidden');
}

function submitMembership() {
  const selectedMembershipId = document.querySelector('input[type="checkbox"]:checked').value;
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const freezeUrl = `https://api.momence.com/host/13752/bought-memberships/${selectedMembershipId}/schedule-freeze`;
  const unfreezeUrl = `https://api.momence.com/host/13752/bought-memberships/${selectedMembershipId}/schedule-unfreeze`;

  Promise.all([
    fetch(freezeUrl, {
      method: 'POST',
      headers: { 'Cookie': sessionCookie },
      body: JSON.stringify({ startDate, endDate })
    }),
    fetch(unfreezeUrl, {
      method: 'POST',
      headers: { 'Cookie': sessionCookie },
      body: JSON.stringify({ startDate, endDate })
    })
  ])
  .then(() => {
    alert('Membership updated successfully!');
    showSpinner(false);
  })
  .catch(error => {
    console.error('Error updating membership:', error);
    showSpinner(false);
  });
}

function showSpinner(show) {
  const spinner = document.getElementById('spinner');
  spinner.style.display = show ? 'block' : 'none';
}
</script>
</body>
</html>
